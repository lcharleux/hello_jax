{"version":2,"kind":"Notebook","sha256":"c4be1270f9044543f50c46ea01332a017ba8fc2f1b53a6b3a6295720e85c8d18","slug":"intro-to-jax","location":"/00_intro_to_jax.ipynb","dependencies":[],"frontmatter":{"title":"Introduction","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"science","language":"python"},"github":"https://github.com/lcharleux/hello_jax","source_url":"https://github.com/lcharleux/hello_jax/blob/main/book/00_intro_to_jax.ipynb","edit_url":"https://github.com/lcharleux/hello_jax/edit/main/book/00_intro_to_jax.ipynb","thumbnail":"/build/96a8e99706627d5058e08d07f71549be.gif","thumbnailOptimized":"/build/96a8e99706627d5058e08d07f71549be.webp","exports":[{"format":"ipynb","filename":"00_intro_to_jax.ipynb","url":"/build/00_intro_to_jax-088a82b753a8b3898710e695c37488f7.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"La promesse de Jax","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ZTFh772ijJ"}],"identifier":"la-promesse-de-jax","label":"La promesse de Jax","html_id":"la-promesse-de-jax","implicit":true,"key":"oqLsuKehcz"}],"key":"Hh1eumk4s8"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Jax promet de pouvoir écrire du code Python et de le déployer sur des plateformes CPU, GPU et TPU-Google sans efforts de traduction particuliers. Il permet aussi de fair des opérations (transformations) assez inédites comme la dérivation automatique des fonctions par rapport à leurs arguments ce qui constitue en soit un game changer pour l’IA et bien d’autres domaines.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Vnbksh0a0G"}],"key":"o22QnrDNJX"}],"key":"rMWG63b9H2"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Le monde de Jax","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rwcAPvuqKJ"}],"identifier":"le-monde-de-jax","label":"Le monde de Jax","html_id":"le-monde-de-jax","implicit":true,"key":"RQfg1w26Ih"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Avec des pincettes énormes, on pourrait résumer le monde de Jax à des données sous forme de ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"nif26OsUYo"},{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"tenseurs","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"CHg8jpemFF"}],"key":"Ro8BDUHjwg"},{"type":"text","value":" qui sont manipulées par des ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"kLDLwEuesl"},{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"fonctions pures","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"mvm7x0yXmF"}],"key":"E3BTVdtrkB"},{"type":"text","value":" auxquelles on applique des ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"bVY0qtuj91"},{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"transformations","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"h1eamorNSR"}],"key":"zYb5E6PMfC"},{"type":"text","value":". Dans les nuances à apporter, il faut noter que la structure des données tensorielle est ou peut être agencée sous forme de ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"p5FS8sMV2x"},{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"pytrees","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"hkjQL8CjFz"}],"key":"p6aMgAyqJB"}],"key":"qY4otug0uW"},{"type":"text","value":" ce qui une idées extrêmement puissante à elle seule, même si ce n’est pas ce qui saute aux yeux quand on début Jax.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"GoV2gLPDBj"}],"key":"y3HqyxFBLo"}],"key":"vco1fBCDoy"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Des fonctions pures ?","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LFdpD5mvgC"}],"identifier":"des-fonctions-pures","label":"Des fonctions pures ?","html_id":"des-fonctions-pures","implicit":true,"key":"c9iXE6eVoW"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Dans Jax, la pureté des fonctions est un sujet qui revient souvent. Une fonction pure est une fonction qui n’a pas d’effets de bords. Elle n’utilise donc pas l’infinité de bidouilles que Python autorise. Dans les grandes lignes, les sorties d’une fonction doivent dépendre de manière déterministe de ses arguments et uniquement d’eux. Cela interdit notamment l’usage de variables globales (enfin, on verra que c’est plus subtile) et aussi de modifier dynamiquement ses propres arguments comme on le ferait souvent en C.\nSi on pense C justement, on peut se dire cette approche est antinomique avec l’économie de mémoire et la performance en général, en fait oui et non. Jax impose cette contrainte car il va voir les fonctions comme des scripts à interpréter dans son langage (voir jaxpr) et à traduire dans un langage dédié à la plateforme cible. L’optimisation au sens ou la verrait en C n’a donc pas lieu d’être. Le but de la pureté est avant tout de lever toute ambiguïté sur le fonctionnement interne de la fonction et de pouvoir y tracer le chemin de l’information.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"yCU06ZiKfs"}],"key":"YQ41Qkr89x"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Voici un petit exemple de fonction pure et de la manière sont jax la comprend:","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"b1jkoKPqbg"}],"key":"l4m0C7kRzl"}],"key":"IPGr23dFzc"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import jax\nfrom jax import numpy as jnp\nimport time\n\ndef dumb_pure_func(x):\n    b = x + 3\n    c = b**2\n    return c\n\n\ndumb_pure_func(3)","key":"CrWric7L3h"},{"type":"output","id":"ez4XKOX4bt7dgeOJy8o0w","data":[{"output_type":"execute_result","execution_count":1,"metadata":{},"data":{"text/plain":{"content":"36","content_type":"text/plain"}}}],"key":"lEhDzJi90n"}],"key":"REsvWGvlbc"},{"type":"block","kind":"notebook-code","data":{"lines_to_next_cell":2},"children":[{"type":"code","lang":"python","executable":true,"value":"jax.make_jaxpr(dumb_pure_func)(2)","key":"xLCWcz8ldh"},{"type":"output","id":"DWWfRvMMYhsaebgPeAvLV","data":[{"output_type":"execute_result","execution_count":2,"metadata":{},"data":{"text/plain":{"content":"{ \u001b[34;1mlambda \u001b[39;22m; a\u001b[35m:i32[]\u001b[39m. \u001b[34;1mlet\n    \u001b[39;22mb\u001b[35m:i32[]\u001b[39m = add a 3:i32[]\n    c\u001b[35m:i32[]\u001b[39m = integer_pow[y=2] b\n  \u001b[34;1min \u001b[39;22m(c,) }","content_type":"text/plain"}}}],"key":"mp4fAHd0H9"}],"key":"jb37Y65sid"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"On remarque Jax comprend bien le fonctionnement interne.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ubiNlPklcZ"}],"key":"Mhx6k9O0CO"}],"key":"AzvEkSScaj"},{"type":"block","kind":"notebook-content","data":{"lines_to_next_cell":2},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Les transformations","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aAYM3poe59"}],"identifier":"les-transformations","label":"Les transformations","html_id":"les-transformations","implicit":true,"key":"DA64W0Iihe"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Imaginons qu’on travaille sur la fonction suivante:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"U2JYILJYj9"}],"key":"e177xKAYCY"}],"key":"IOWox8ccZ5"},{"type":"block","kind":"notebook-code","data":{"lines_to_next_cell":2},"children":[{"type":"code","lang":"python","executable":true,"value":"def myfunc(x, a=1, b=1, c=1):\n    return a * x**2 + b * x + c\n\n\njax.make_jaxpr(myfunc)(3, 1, 1, 1)","key":"QO39tuhTcS"},{"type":"output","id":"tO3NRGlyttPr5OQV5cRqO","data":[{"output_type":"execute_result","execution_count":3,"metadata":{},"data":{"text/plain":{"content":"{ \u001b[34;1mlambda \u001b[39;22m; a\u001b[35m:i32[]\u001b[39m b\u001b[35m:i32[]\u001b[39m c\u001b[35m:i32[]\u001b[39m d\u001b[35m:i32[]\u001b[39m. \u001b[34;1mlet\n    \u001b[39;22me\u001b[35m:i32[]\u001b[39m = integer_pow[y=2] a\n    f\u001b[35m:i32[]\u001b[39m = mul b e\n    g\u001b[35m:i32[]\u001b[39m = mul c a\n    h\u001b[35m:i32[]\u001b[39m = add f g\n    i\u001b[35m:i32[]\u001b[39m = add h d\n  \u001b[34;1min \u001b[39;22m(i,) }","content_type":"text/plain"}}}],"key":"fclKvoGkWN"}],"key":"jL7ORNKg90"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"myfunc(5)","key":"E2HHKZcm7B"},{"type":"output","id":"4UrTfNqaH2Akr9qCRWSRk","data":[{"output_type":"execute_result","execution_count":4,"metadata":{},"data":{"text/plain":{"content":"31","content_type":"text/plain"}}}],"key":"OYJaRaEpqN"}],"key":"h0f3oN0WM2"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Vectoriser avec ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"K2kAdJdLf4"},{"type":"inlineCode","value":"vmap","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"veorxl9mHQ"}],"identifier":"vectoriser-avec-vmap","label":"Vectoriser avec vmap","html_id":"vectoriser-avec-vmap","implicit":true,"key":"p62nWIv0xa"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"On peut vectoriser par rapport à un axe par exemple avec vmap.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"uzItAw9z0I"}],"key":"ghyLIaPofn"}],"key":"KIXYuTCZeR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"vmyfunc = jax.vmap(myfunc, in_axes=(0, None, None, None))\nxa = jnp.linspace(0.0, 5.0, 6)\nvmyfunc(xa, 1, 1, 1)","key":"UjTASbzdd6"},{"type":"output","id":"8A_jKxc2Ficn93no2oAQN","data":[{"output_type":"execute_result","execution_count":5,"metadata":{},"data":{"text/plain":{"content":"Array([ 1.,  3.,  7., 13., 21., 31.], dtype=float32)","content_type":"text/plain"}}}],"key":"bluL8Cx9hJ"}],"key":"GkmqgS0csP"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Mais on peut faire des structure bien plus complexes en combinant plusieurs transformations:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cORAyze8Jh"}],"key":"IRp1wfzXJf"}],"key":"xWQ3M59t4L"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"vmyfunc2 = jax.vmap(vmyfunc, in_axes=(None, 0, None, None))\naa = jnp.linspace(0., 1., 3)\nvmyfunc2(xa, aa, 1,1)","key":"LX43k15UEF"},{"type":"output","id":"qJw4sU46WF-O17OtnktbT","data":[{"output_type":"execute_result","execution_count":6,"metadata":{},"data":{"text/plain":{"content":"Array([[ 1. ,  2. ,  3. ,  4. ,  5. ,  6. ],\n       [ 1. ,  2.5,  5. ,  8.5, 13. , 18.5],\n       [ 1. ,  3. ,  7. , 13. , 21. , 31. ]], dtype=float32)","content_type":"text/plain"}}}],"key":"S4fKXrqqMp"}],"key":"yLsbr8cwcb"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Le potentiel est énorme car on peut soit vectoriser en plusieurs strates ou aussi le faire d’un coup en jouant sur les axes selon les besoins.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"lPFwvbc30P"}],"key":"mbRL2vBb84"}],"key":"RCjoiSAAgn"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Compiler avec ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Q5O7HZgojP"},{"type":"inlineCode","value":"jit","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ot90TizGjo"}],"identifier":"compiler-avec-jit","label":"Compiler avec jit","html_id":"compiler-avec-jit","implicit":true,"key":"xPNUa8RWT7"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Il est possible de compiler tout ou partie du code avec ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"qDa66F2jLL"},{"type":"inlineCode","value":"jit","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"MPDAv37IKF"},{"type":"text","value":". La compilation va coûter quelques milisecondes et permettre une execution optimisée par la suite.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"fgiM3Cj4Uv"}],"key":"axiBnzlnjg"}],"key":"S7vKRR9RvS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"\nNe = 100\nxa = jnp.linspace(0.0, 5.0, 6000)\naa = jnp.linspace(0., 1., 3000)\nt0 = time.time()\nfor e in range(Ne):\n    val = vmyfunc2(xa, aa, 1,1)\n    val.block_until_ready()\nt1 = time.time()\ndt0 = (t1 -t0)/ Ne\nprint( f\"Exectution took {dt0*1.e3:.2f} ms\")","key":"Vc731ywn2Q"},{"type":"output","id":"dWRRbKpdJxMQLQw7hArk_","data":[{"name":"stdout","output_type":"stream","text":"Exectution took 7.43 ms\n"}],"key":"S1uqDvmNJt"}],"key":"TV13NLdozp"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"jvmyfunc2 = jax.jit(vmyfunc2)\nt0 = time.time()\nval = jvmyfunc2(xa, aa, 1,1)\nval.block_until_ready()\nt1 = time.time()\ndt1 = t1 -t0\nprint( f\"Compilation + first execution took {dt1*1.e3:.2f} ms\")","key":"yNuy85E5lx"},{"type":"output","id":"vI9g3CvH3L6WfgXxJpf0v","data":[{"name":"stdout","output_type":"stream","text":"Compilation + first execution took 21.05 ms\n"}],"key":"cmepzQkEZU"}],"key":"nhTOXzkW8c"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"t0 = time.time()\nfor e in range(Ne):\n    val = jvmyfunc2(xa, aa, 1,1)\n    val.block_until_ready()\nt1 = time.time()\ndt2 = (t1 -t0) / Ne\nprint( f\"Second execution took {dt2*1.e3:.2f} ms\")","key":"IuPwGuFtyN"},{"type":"output","id":"0JPR8B8Bd2fykaSUSt5Ai","data":[{"name":"stdout","output_type":"stream","text":"Second execution took 2.04 ms\n"}],"key":"zp20yZKNTP"}],"key":"i4CyHTAHa6"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"On a donc gagné du temps avec le jit et ce malgré le fait que notre fonction est très simple et donc très optimisée à la base. Cette tendance sera amplifiée sur des calculs lourds sur GPU/TPU.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"me5cZd6QaC"}],"key":"h1q1V6vbpq"}],"key":"VoBhlcA6qq"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Autres transformations","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NsZH3DD1zP"}],"identifier":"autres-transformations","label":"Autres transformations","html_id":"autres-transformations","implicit":true,"key":"ZIQUEsWbjt"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Les autres transformations ne sont pas cruciales maintenant alors je les passe sous couvert. Mais elles sont ultra intéressantes dans d’autres cas, surtout ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"IbrRycBexM"},{"type":"inlineCode","value":"grad","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ARIB0CNZqJ"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"aT6ehwDMZA"}],"key":"YJ0VWr8W3j"}],"key":"NlHXY2ZqXn"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"","key":"cHH8MnN8o2"},{"type":"output","id":"Jm9i-elxYhHU60iQ7ygpU","data":[],"key":"DNKfW9FVbe"}],"key":"iPw0pPLAis"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Liste non exhaustive des limitations de Jax","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"E9yCltN5ih"}],"identifier":"liste-non-exhaustive-des-limitations-de-jax","label":"Liste non exhaustive des limitations de Jax","html_id":"liste-non-exhaustive-des-limitations-de-jax","implicit":true,"key":"Q7JzUzIMzy"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Forcément, cette belle promesse vient avec pas mal de limitations.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"BQfzso1YF3"}],"key":"MuGrSpL5eZ"},{"type":"heading","depth":3,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Les structures de contrôle","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"oVvoyml8dY"}],"identifier":"les-structures-de-contr-le","label":"Les structures de contrôle","html_id":"les-structures-de-contr-le","implicit":true,"key":"XnaAjESxpY"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"On commence par une des plus agacentes au début, les structures de contrôle. Fini les ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"MZWibnFqdk"},{"type":"inlineCode","value":"if","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"fbD54hHfTI"},{"type":"text","value":", ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"DhGnvtih9k"},{"type":"inlineCode","value":"for","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Ygqeuyeero"},{"type":"text","value":"et ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"FoI07vbYHm"},{"type":"inlineCode","value":"while","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"mHEghcvSvp"},{"type":"text","value":".","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"mqZnSXY4ht"}],"key":"XLdnHOJ7Of"},{"type":"image","url":"/build/96a8e99706627d5058e08d07f71549be.gif","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"AlRz1lxhVW","urlSource":"https://media1.tenor.com/m/-mkYatTHWB0AAAAC/why-whyy.gif","urlOptimized":"/build/96a8e99706627d5058e08d07f71549be.webp"},{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"En fait, ces dernières ne sont pas claires dans leurs buts et peuvent correspondre à plusieurs objectifs. Jax fournit donc des outils de remplacements qui ne manqueront pas de vous énerver (parfois). A titre d’exemple, ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"KRJb9PoNGw"},{"type":"inlineCode","value":"for","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"LcUFHWl7qP"},{"type":"text","value":"sera remplacée alternativement selon les buts par ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"ehnav0Knsm"},{"type":"inlineCode","value":"vmap","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"dhz24YBdky"},{"type":"text","value":", ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"D0rS1xx3Cu"},{"type":"inlineCode","value":"scan","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"vXP7dcVQUA"},{"type":"text","value":", ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"fyeapZZI58"},{"type":"inlineCode","value":"where","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"OqJmS271hI"},{"type":"text","value":", ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"hu6QhBCykh"},{"type":"inlineCode","value":"lax.fori_loop","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"ajoNiIkIth"},{"type":"text","value":" ou pourra rester ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"L0MN52Avy1"},{"type":"inlineCode","value":"for","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"OUAHwEYel8"},{"type":"text","value":" dans ces bien choisis.","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"Gay0AHFXS7"}],"key":"vrxPAcs3Vc"}],"key":"xgRoh5aoPI"},{"type":"block","kind":"notebook-content","data":{"lines_to_next_cell":2},"children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"L’allocation dynamique de mémoire","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"isWiR7Mili"}],"identifier":"lallocation-dynamique-de-m-moire","label":"L’allocation dynamique de mémoire","html_id":"lallocation-dynamique-de-m-moire","implicit":true,"key":"Bd6wbp1ZvT"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Dans le monde de jax, il est interdit d’allouer dynamiquement de la mémoire, par exemple en créant des array de taille inconnue à la compilation. Cela ne manquera pas de vous créer des frustrations. On verra aussi qu’il est possible de trouver des compromis sur ce point. Le chapitre des ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"p0TTVuk08N"},{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"sharp bits","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"cmwbNPKSqR"}],"key":"KUn9JydZKQ"},{"type":"text","value":" et globalement toutes les prises de parole de JakeVPD et Patrick Kidger mérite d’être lues pour comprendre la parole sainte à ce sujet.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"wg0JdtUbRm"}],"key":"pmXcn55cYa"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Exemple:","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"U0EeRkMRH9"}],"key":"Gz5sT97Uu9"}],"key":"IWCWMhoxbJ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def dumb_func_allocating_memory(n):\n    a = jnp.arange(n)\n    return a","key":"sRZQeOq2OV"},{"type":"output","id":"lcprOP3hvyftik3RLRPrk","data":[],"key":"myjU3xsKwI"}],"key":"GmcTHDPgGK"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"#jax.make_jaxpr(dumb_func_allocating_memory)(2) # Uncommment to see the error.","key":"bl4elnBxmf"},{"type":"output","id":"pUEZsvjBnyogTHE2Nhl6h","data":[],"key":"vgdUa01W9B"}],"key":"ilGsHpyirE"},{"type":"block","kind":"notebook-content","children":[{"type":"thematicBreak","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"X1Pf7FIj2k"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"ConcretizationTypeError                   Traceback (most recent call last)\nCell In[11], line 1\n----> 1 jax.make_jaxpr(dumb_func_allocating_memory)(2)","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"N3oBPZWfcT"}],"key":"lLDFlbfOZY"},{"type":"code","lang":"","value":"[... skipping hidden 14 frame]","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"YVKhQx5D0f"},{"type":"paragraph","position":{"start":{"line":8,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"Cell In[10], line 2, in dumb_func_allocating_memory(n)\n1 def dumb_func_allocating_memory(n):\n----> 2     a = jnp.arange(n)\n3     return a","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"IhwWZ1SRrs"}],"key":"YAZ0LD8HOD"},{"type":"paragraph","position":{"start":{"line":13,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"text","value":"File ~/miniforge3/envs/science/lib/python3.12/site-packages/jax/_src/numpy/lax_numpy.py:5947, in arange(start, stop, step, dtype, device, out_sharding)\n5945 if sharding is None or not sharding._is_concrete:\n5946   assert sharding is None or isinstance(sharding, NamedSharding)\n-> 5947   return _arange(start, stop=stop, step=step, dtype=dtype,\n5948                  out_sharding=sharding)\n5949 else:\n5950   output = _arange(start, stop=stop, step=step, dtype=dtype)","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"YJ2zVJtBiO"}],"key":"OSTjULrRW8"},{"type":"paragraph","position":{"start":{"line":21,"column":1},"end":{"line":26,"column":1}},"children":[{"type":"text","value":"File ~/miniforge3/envs/science/lib/python3.12/site-packages/jax/_src/numpy/lax_numpy.py:5962, in _arange(start, stop, step, dtype, out_sharding)\n5960 util.check_arraylike(“arange”, start)\n5961 if stop is None and step is None:\n-> 5962   start = core.concrete_or_error(None, start, “It arose in the jnp.arange argument ‘stop’”)\n5963 else:\n5964   start = core.concrete_or_error(None, start, “It arose in the jnp.arange argument ‘start’”)","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"EjGaTijp85"}],"key":"lkvvVm57W4"},{"type":"paragraph","position":{"start":{"line":28,"column":1},"end":{"line":33,"column":1}},"children":[{"type":"text","value":"File ~/miniforge3/envs/science/lib/python3.12/site-packages/jax/_src/core.py:1847, in concrete_or_error(force, val, context)\n1845 maybe_concrete = val.to_concrete_value()\n1846 if maybe_concrete is None:\n-> 1847   raise ConcretizationTypeError(val, context)\n1848 else:\n1849   return force(maybe_concrete)","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"DNay2HCWUJ"}],"key":"AvFawpmzPE"},{"type":"paragraph","position":{"start":{"line":35,"column":1},"end":{"line":37,"column":1}},"children":[{"type":"text","value":"ConcretizationTypeError: Abstract tracer value encountered where concrete value is expected: traced array with shape int32[]\nIt arose in the jnp.arange argument ‘stop’\nThe error occurred while tracing the function dumb_func_allocating_memory at /var/folders/67/hblp6z8n36ldk_9_bl9g80kh0000gn/T/ipykernel_50677/3347747001.py:1 for jit. This concrete value was not available in Python because it depends on the value of the argument n.","position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"key":"BWt0tAGNC1"}],"key":"qzmFI4li7G"},{"type":"paragraph","position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"children":[{"type":"text","value":"See ","position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"key":"awF7Rrnosy"},{"type":"link","url":"https://docs.jax.dev/en/latest/errors.html#jax.errors.ConcretizationTypeError","position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"children":[{"type":"text","value":"https://​docs​.jax​.dev​/en​/latest​/errors​.html​#jax​.errors​.ConcretizationTypeError","position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"key":"mWxTUBoi7T"}],"urlSource":"https://docs.jax.dev/en/latest/errors.html#jax.errors.ConcretizationTypeError","key":"aHoAilSm19"}],"key":"DiLdJB4GAn"}],"key":"a4FugTu1gV"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Frustration, colère ...","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"hmigy1HAMY"}],"key":"rjfBlORFT8"}],"key":"TcgNmNok3X"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Dans un tel, cas il faut généralement se demander si on a vraiment besoin que ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mGcHtxJUmo"},{"type":"inlineCode","value":"n","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mGKq8WLCHT"},{"type":"text","value":"soit dynamique. Si c’est vraiment le cas, alors on peut le rendre statique (au sens jax) en spécifiant:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"s0UsBQiInQ"}],"key":"z5LVKT2Wje"}],"key":"fWTuZtKPfc"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import numpy as np\n\n\ndef make_dumb_function_allocating_memory(n):\n    def dumb_func_allocating_memory2(a):\n        x = a * jnp.arange(n)\n        return x\n\n    return dumb_func_allocating_memory2\n\n\ndfam = jax.jit(make_dumb_function_allocating_memory(3))","key":"ekTLU9ypX4"},{"type":"output","id":"eCvaY8aJOPJpk6zpWjab_","data":[],"key":"TPucxAjSrN"}],"key":"BmtrVCxNP5"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"jax.make_jaxpr(dfam)(2)","key":"G3Uv6MLcH8"},{"type":"output","id":"ToO685aNCKToqVL0O8JQJ","data":[{"output_type":"execute_result","execution_count":13,"metadata":{},"data":{"text/plain":{"content":"{ \u001b[34;1mlambda \u001b[39;22m; a\u001b[35m:i32[]\u001b[39m. \u001b[34;1mlet\n    \u001b[39;22mb\u001b[35m:i32[3]\u001b[39m = jit[\n      name=dumb_func_allocating_memory2\n      jaxpr={ \u001b[34;1mlambda \u001b[39;22m; a\u001b[35m:i32[]\u001b[39m. \u001b[34;1mlet\n          \u001b[39;22mc\u001b[35m:i32[3]\u001b[39m = iota[dimension=0 dtype=int32 shape=(3,) sharding=None] \n          d\u001b[35m:i32[]\u001b[39m = convert_element_type[new_dtype=int32 weak_type=False] a\n          b\u001b[35m:i32[3]\u001b[39m = mul d c\n        \u001b[34;1min \u001b[39;22m(b,) }\n    ] a\n  \u001b[34;1min \u001b[39;22m(b,) }","content_type":"text/plain"}}}],"key":"oRYVtzqQB5"}],"key":"rhqspP5hM9"}],"key":"KBW8YThKu2"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{}},"domain":"http://localhost:3001"}